# 内存性能

## 虚拟内存空间分布

### 用户空间内存

- 只读段，包括代码和常量等
- 数据段，包括全局变量等
- 堆，包括动态分配的内存，从低地址开始向上增
- 文件映射段，包括动态库、共享内存等，从高地址开始向下增长
- 栈，包括局部变量和函数调用的上下文等。栈的大小是固定的

### 内存分配与回收

- malloc

  - brk
    - 对小块内存（小于 128K），C 标准库使用 brk() 来分配，也就是通过移动堆顶的位置来分配内存
    - 这些内存释放后并不会立刻归还系统，而是被缓存起来，这样就可以重复使用
    - 频繁的内存分配和释放会造成内存碎片
  - mmap
    - 大块内存（大于 128K），则直接使用内存映射 mmap() 来分配，也就是在文件映射段找一块空闲内存分配出去
    - 频繁的内存分配会导致大量的缺页异常，使内核的管理负担增大

- 内存释放

  - free
  - unmap

- 系统回收内存

  - 内存回收
    - 基于 LRU（Least Recently Used）算法，回收缓存
    - 基于 LRU，回收回收不常访问的 Swap 匿名页
    - OOM 机制按照 oom_score 给进程排序。oom_score 越大，进程就越容易被系统杀死
      - 当系统发现内存不足以分配新的内存请求时，尝试直接回收内存
      - OOM，杀死进程
  - kswapd0 内核线程用来定期回收内存
    - 内存水位线：页最小阈值（pages_min）、页低阈值（pages_low）和页高阈值（pages_high）。剩余内存，则使用 pages_free 表示
    - 剩余内存小于页最小阈值，说明进程可用内存都耗尽了，只有内核才可以分配内存
    - 剩余内存落在页最小阈值和页低阈值中间，说明内存压力比较大，剩余内存不多了。这时 kswapd0 会执行内存回收，直到剩余内存大于高阈值为止
    - 剩余内存落在页低阈值和页高阈值中间，说明内存有一定压力，但还可以满足新内存请求
    - 剩余内存大于页高阈值，说明剩余内存比较多，没有内存压力

- 内存泄漏查询
  - memleak 检查进程内存使用

## Buffer/Cache

- Buffer 缓存对磁盘的读写数据
- Cache 缓存对文件系统的读写数据

- 缓存命中率

  - 工具
    - cachetop 默认按照缓存的命中次数（HITS）排序，展示了每个进程的缓存命中情况
    - cachestat 查询系统缓存利用情况
    - pcstat 查看文件的缓存情况
    - dd 作为一个磁盘和文件的拷贝工具，经常被拿来测试磁盘或者文件系统的读写性能

- Buffers 和 Cache 都是操作系统来管理的，应用程序并不能直接控制这些缓存的内容和生命周期。在应用程序开发中，一般要用专门的缓存组件

## Swap

- 过程
  - 换出，就是把进程暂时不用的内存数据存储到磁盘中，并释放这些数据占用的内存
  - 换入，则是在进程再次访问这些内存的时候，把它们从磁盘读到内存中来

## 内存性能指标

- 系统内存使用情况，如已用内存、剩余内存、共享内存、可用内存、缓存和缓冲区的用量等
  - 已用内存和剩余内存很容易理解，就是已经使用和还未使用的内存
  - 共享内存是通过 tmpfs 实现的，所以它的大小也就是 tmpfs 使用的内存大小。tmpfs 其实也是一种特殊的缓存
  - 可用内存是新进程可以使用的最大内存，它包括剩余内存和可回收缓存
  - 缓存包括两部分，一部分是磁盘读取文件的页缓存，用来缓存从磁盘读取的数据，可以加快以后再次访问的速度。另一部分，则是 Slab 分配器中的可回收内存
  - 缓冲区是对原始磁盘块的临时存储，用来缓存将要写入磁盘的数据。这样，内核就可以把分散的写集中起来，统一优化磁盘写入。
- 进程内存使用情况，比如进程的虚拟内存、常驻内存、共享内存以及 Swap 内存等
  - 虚拟内存，包括了进程代码段、数据段、共享内存、已经申请的堆内存和已经换出的内存等。这里要注意，已经申请的内存，即使还没有分配物理内存，也算作虚拟内存
  - 常驻内存是进程实际使用的物理内存，不过，它不包括 Swap 和共享内存
  - 共享内存，既包括与其他进程共同使用的真实的共享内存，还包括了加载的动态链接库以及程序的代码段等
  - Swap 内存，是指通过 Swap 换出到磁盘的内存。

## 查看内存使用情况

- 工具
  - free
  - top
  - cat /proc/[pid]/status
  - pmap -x [pid]
  - dd
  - bcc
  - pcstat
  - memleak
  - smem --sort swap 命令可以直接将进程按照 swap 使用量排序显示
