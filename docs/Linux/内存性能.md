# 内存性能

## 虚拟内存空间分布

### 用户空间内存

- 只读段，包括代码和常量等
- 数据段，包括全局变量等
- 堆，包括动态分配的内存，从低地址开始向上增
- 文件映射段，包括动态库、共享内存等，从高地址开始向下增长
- 栈，包括局部变量和函数调用的上下文等。栈的大小是固定的

### 内存分配与回收

- malloc

  - brk
    - 对小块内存（小于 128K），C 标准库使用 brk() 来分配，也就是通过移动堆顶的位置来分配内存
    - 这些内存释放后并不会立刻归还系统，而是被缓存起来，这样就可以重复使用
    - 频繁的内存分配和释放会造成内存碎片
  - mmap
    - 大块内存（大于 128K），则直接使用内存映射 mmap() 来分配，也就是在文件映射段找一块空闲内存分配出去
    - 频繁的内存分配会导致大量的缺页异常，使内核的管理负担增大

- 内存释放

  - free
  - unmap

- 系统回收内存

  - 回收缓存，比如使用 LRU（Least Recently Used）算法，回收最近使用最少的内存页面
  - 回收不常访问的内存，把不常用的内存通过交换分区直接写到磁盘中
  - 杀死进程，内存紧张时系统还会通过 OOM（Out of Memory），直接杀掉占用大量内存的进程

- 内存泄漏查询
  - memleak 检查进程内存使用

## Buffer/Cache

- Buffer 缓存对磁盘的读写数据
- Cache 缓存对文件系统的读写数据

- 缓存命中率

  - 工具
    - cachetop 默认按照缓存的命中次数（HITS）排序，展示了每个进程的缓存命中情况
    - cachestat 查询系统缓存利用情况
    - pcstat 查看文件的缓存情况
    - dd 作为一个磁盘和文件的拷贝工具，经常被拿来测试磁盘或者文件系统的读写性能

- Buffers 和 Cache 都是操作系统来管理的，应用程序并不能直接控制这些缓存的内容和生命周期。在应用程序开发中，一般要用专门的缓存组件

## Swap

- 过程
  - 换出，就是把进程暂时不用的内存数据存储到磁盘中，并释放这些数据占用的内存
  - 换入，则是在进程再次访问这些内存的时候，把它们从磁盘读到内存中来

## 查看内存使用情况

- 工具
  - free
  - top
  - cat /proc/[pid]/status
  - pmap -x [pid]
  - dd
  - bcc
  - pcstat
  - memleak
