# WebSocket

- WebSocket 是 HTML5 开始提供的一种独立在单个 TCP 连接上进行全双工通讯的有状态的协议(不同于无状态的 HTTP)，并且还能支持二进制帧、扩展协议、部分自定义的子协议、压缩等特性。

## 优点

- 较少的控制开销，在连接创建后，服务器和客户端之间交换数据时，用于协议控制的数据包头部相对较小
  - 在不包含扩展的情况下，对于服务器到客户端的内容，此头部大小只有2至10字节（和数据包长度有关）
  - 对于客户端到服务器的内容，此头部还需要加上额外的4字节的掩码。相对于 HTTP 请求每次都要携带完整的头部，此项开销显著减少了

- 更强的实时性，由于协议是全双工的，所以服务器可以随时主动给客户端下发数据
  - 相对于HTTP请求需要等待客户端发起请求服务端才能响应，延迟明显更少；即使是和Comet等类似的长轮询比较，其也能在短时间内更多次地传递数据

- 长连接，保持连接状态
  - 与HTTP不同的是，Websocket需要先创建连接，这就使得其成为一种有状态的协议，之后通信时可以省略部分状态信息。而HTTP请求可能需要在每个请求都携带状态信息（如身份认证等）

- 双向通信、更好的二进制支持
  - 与 HTTP 协议有着良好的兼容性
  - 默认端口也是 80 和 443，并且握手阶段采用 HTTP 协议，因此握手时不容易被屏蔽，能通过各种 HTTP 代理服务器

## WebSocket 握手过程

- 发起 wss 的握手请求
  - 协议内容
    - 请求的方法必须是GET，HTTP版本必须至少是1.1
    - ws协议：普通请求，占用与 HTTP 相同的 80 端口；wss协议：基于 SSL 的安全传输，占用与 TLS 相同的 443 端口
    - 使用Upgrade 进行了协议升级，指明升级到 websocket 协议
      - Connection: Upgrade
      - Upgrade: websocket
    - Sec-WebSocket-Version
      - 表示 WebSocket 的版本
    - Sec-WebSocket-Key
      - 由浏览器随机生成的，提供基本的防护，防止恶意或者无意的连接
    - Sec-WebSocket-Protocol
      - 用于协商应用子协议，客户端发送支持的协议列表
    - Sec-WebSocket-Extensions
      - 用于协商本次连接要使用的 WebSocket 扩展，客户端发送支持的扩展

- Response
  - 确认升级到 WebSocket 协议
  - Sec-WebSocket-Accept
    - 经过服务器确认后，并且加密之后的 Sec-WebSocket-Key
      - 先将客户端请求头里面的 Sec-WebSocket-Key 取出来跟 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 拼接
        - 这个 GUID 是唯一固定不变的
      - 然后进行 SHA-1 哈希，最后进行 base64-encoded 得到的结果就是 Sec-WebSocket-Accept
  - Sec-WebSocket-Protocol
    - 用于协商应用子协议，服务端返回支持的协议列表
    - 服务器必须只回应一个协议名
  - Sec-WebSocket-Extensions
    - 用于协商本次连接要使用的 WebSocket 扩展，服务器通过返回相同的首部确认自己支持一或多个扩展
    - 服务端如果都不支持，不会导致握手失败，但是此次连接不能使用任何扩展

## WebSocket 协议扩展

- 多路复用扩展
  - 这个扩展可以将 WebSocket 的逻辑连接独立出来，实现共享底层的 TCP 连接
  - 进行了多路复用扩展以后，多个连接复用一个 TCP 连接，每个信道依旧会存在队首阻塞的问题。除了多路复用，还要进行多路并行发送消息
  - 不进行多路复用扩展，每个 WebSocket 连接都只能独享专门的一个 TCP 连接，而且当遇到一个巨大的消息分成多个帧的时候，容易产生队首阻塞的情况。队首阻塞会导致延迟，所以分成多个帧的时候能尽量的小是关键

- 压缩扩展(Compression Extensions for WebSocket)
  - 给 WebSocket 协议增加了压缩功能

## WebSocket 数据帧

- 二进制消息分帧机制
  - 把应用的消息分割成一个或多个帧，接收方接到到多个帧会进行组装，等到接收到完整消息之后再通知接收端
